:data-uri:
:toc2:
:rpms: link:https://github.com/jboss-gpe-ose/jboss_bpm_soa_rpmbuild[RPMs]
:bpmcart: link:https://github.com/jboss-gpe-ose/openshift-origin-cartridge-bpms-full[Red Hat GPE's BPM Suite 6 cartridge]
:fswcart: link:https://github.com/jboss-gpe-ose/openshift-origin-cartridge-fsw-full[Red Hat GPE's FSW cartridge]
:bpmproduct: link:https://access.redhat.com/site/documentation/en-US/Red_Hat_JBoss_BPM_Suite/[Red Hat's BPM Suite 6 product]
:fswproduct: link:https://access.redhat.com/site/documentation/en-US/Red_Hat_JBoss_Fuse_Service_Works/[Red Hat's FSW product]

image::images/rhheader.png[width=900]

:numbered!:
[abstract]
== Fuse Service Works / BPM Suite 6 Integration

== Overview
Many enterprise software applications leverage a Business Process Management (BPM) tool.
The BPM solution maintains and manages the state of long-running business processes.
In an enterprise software application that leverages a BPM tool, it is highly recommended that business services continue to be implemented independent of the BPM tool and in adherence to SOA.
In particular, these business services should be course-grained, re-usable, contract-based, stateless and be exposed by standards based protocols.
During the lifecycle of a business process instance, nodes of that process instance should invoke the remote services that encapsulate the business logic.
Correspondingly, these business services should drive the lifecylce of process instances by invoking APIs provided by the BPM tool.

This _xPaaS_ reference architecture demonstrates a _process tier_ and _service tier_ interacting with each-other.
Specifically, a SwitchYard SCA application drives the life-cycle of a BPMN2 process instance whose state is managed remotely by BPM Suite 6.
To do so, the SwitchYard SCA application invokes the REST API of the BPM Suite 6 execution server using the stock RESTEasy composite binding implementation.
The _process tier_ is implemented in a Red Hat Openshift _gear_ provisioned with Red Hat JBoss BPM Suite 6.
The _service tier_ is implemented in a Red Hat Openshift _gear_ provisioned with Red Hat JBoss Fuse Service Works 6.

image::images/dep_arch.png[]

== Pre-Requisites
The remainder of this documentation provides instructions for installation, configuration and execution of this reference architecture.
The following is a list of pre-requisites:

. {osetools}
. Openshift Enterprise 2.* environment that has been installed with {rpms} needed to support {cart}.  Contact the Red Hat GPE team for more details.
. medium-sized Openshift Enterprise gear provisioned with {bpmcart} and mysql-5.
. medium-sized Openshift Enterprise gear provisioned with {fswcart} and mysql-5.
. ssh client
. maven 3.0.5 (or greater)
. git client
. familiarity with {bpmproduct}
. familiarity with {fswproduct}
. proficiency with basic *nix command line
. proficiency with vi

As is evidenced by these pre-requisites, the assumed BPM Suite 6 runtime environment for this reference architecture documentation is an Openshift Enterprise gear.
However, BPM Suite 6 and Fuse Service Works can be installed in non-PaaS local environments.
Thus it could be possible to execute this reference architecture in a non-PaaS local environment as well.

== Configuration and Deployment : Local Environment

=== local: Clone this reference architecture
This reference architecture will be cloned both in your local computer as well as in your remote BPM Suite 6 Openshift environment.
To clone this reference architecture in your local environment, execute the following:

-----
git clone https://github.com/jboss-gpe-ref-archs/fsw_bpms_integration.git
-----

Doing so will create a directory in your local computer called:  _fsw_bpms_integration_.
For the purposes of this reference architecture, this directory will be referred to as _$REF_ARCH_HOME_.


=== local: Build the Reference Architecture
This reference architecture includes various sub-projects that need to be built locally.
To build the various sub-projects, execute the following:

. cd $REF_ARCH_HOME
. mvn clean install

=== local: Domain model library deployment to Openshift Environments
In $REF_ARCH_HOME, there is a directory called `domain`.
This directory contains the domain classes that will be referenced by other sub-projects of this reference architecture.
Notice that the domain classes are annoted to enable serialization via Java Architecture for XML Binding (JAXB).

In the previous step, the domain model library was built.
These next steps involves installing the jar as a static module in both your FSW and BPM Suite 6 servers running in OpenShift.

. `cd $REF_ARCH_HOME`
. `scp -r domain/conf/com <your_openshift_url>:~/app-root/data/appModules/`
. `scp domain/target/domain-1.0.jar    <ssh_url_to_your_openshift_environment>:~/app-root/data/appModules/com/redhat/gpe/refarch/fsw_bpms_integration/domain/main/`

== Configuration and Deployment:  BPM Suite 6 

=== BPM Suite 6:  Define explicit dependency
In the previous step, the jaxb annotated domain classes were deployed to both the FSW and BPM Suite 6 enabled Openshift gears.
This step involves adding an explicit dependency to the BPM Suite 6 _Business-Central_ web application that references this static module.

. ssh <your_bpms_openshift_url>
. Edit the following file:  `~/bpms/standalone/deployments/business-central.war/WEB-INF/jboss-deployment-structure.xml`
.. Add the following to the list of dependencies:

-----
<module name="com.redhat.gpe.refarch.fsw_bpms_integration.domain" export="true"/>
-----

[start=4]
. Save the changes to the file
. Restart your OpenShift BPM Suite 6 instance

=== BPM Suite 6:  Clone this reference architecture
This reference architecture includes a business process called _policyQuoteProcessMap_ that includes a human task node followed by a RESTful _Service Task_ .
It is this process whose lifecycle will be managed remotely via the Execution Server of BPM Suite 6.

image::images/processTier_bpmn.png[]

Use the following steps to clone this reference architecture in BPM Suite 6:

. Log into the Business-Central web application of BPM Suite 6 and navigate to:  Authoring -> Administration.
. Select `Organizational Units` -> `Manage Organizational Units`
. Under `Organizational Unit Manager`, select the `Add` button
. Enter a name of _gpe_ and an owner of _jboss_. Click `Ok`
. Clone this fsw_bpms_integration repository in BPM Suite 6
.. Select `Repositories` -> `Clone Repository` .  
.. Populate the _Clone Repository_ box as follows and then click _Clone_ :

image::images/clone_repo.png[]

Enter _fswbpmsintegration_ as the value of the _repository name_.  
The value of _Git URL_ is the URL to this reference architecture in github:

-----
https://github.com/jboss-gpe-ref-archs/fsw_bpms_integration.git
-----

Once successfully cloned, BPM Suite 6 will pop-up a new dialog box with the message:  _The repository is cloned successfully_

=== BPM Suite 6:  Modify parameters of RESTful Service Task
The _policyQuoteProcessMap_ process includes as its last node a RESTful Service Task.
This RESTful Service Task invokes a HTTP POST operation on a remote resource exposed by the _policyQuoteMgmt_ SwitchYard application (details of which will be discussed later in this reference architecture).
The values of this HTTP POST operation are configured in the parameters of the RESTful Service Task.
To customize these parameters for your environment, execute the following:

. Log into the Business-Central web application of BPM Suite 6 and navigate to:   Authoring -> Project Authoring.
. In the _Project Explorer_ section, drill-down into:  com.redhat.gpe.refarch.fsw_bpms_integration.processTier
. In the _Business Processes_ section, select:  _policyQuoteProcessMap_.
. In the _policyQuoteProcessMap_ process definition, click the last node entitled: _POST Review Results_.
. In the _Properties_ section of the BPM Designer, click the _Assignments_ property such that the _Editor for Data Assignments_ pop-up appears:

image::images/mod_service_task.png[]

* Fill in the values for each _Assignment_ as follows:

. `Url`   :   http://<your_fsw_server_address>/policyQuoteMgmt/policy
. `ConnectTimeout`  :   5000
. `Password`  :   jboss
. `Username`  :   brms
. `Method`    :   POST
. `ReadTimeout`    :   5000


* Save the changes to the process definition.

=== BPM Suite 6:  Deploy _org.acme.insurance:policyquote:1.0_ KIE project

* Navigate to the _Project Editor_ and click the button at the top-right to `Build & Deploy`
** A light-green pop-up should appear indicating: _Build Successful_

The _org.acme.insurance:policyquote:1.0_ KIE project is now deployed as a maven artifact in your remote BPM Suite 6 environment and is registered with the embedded _Execution Server_.
The lifecycle of the project's business processes can now be remotely driven through the REST API of the _Execution Server_.
The next requirement to execute this reference architecture is to configure services in your remote FSW enabled Openshift environment.


== Configuration and Deployment:  Fuse Service Works

=== FSW:  Define System Properties
This reference architecture includes SwitchYard applications that define composite reference bindings that invoke the _Execution Server_ of a remote BPM Suite 6 environment.
In your FSW enabled environment, Java system properties will be added that indicate the network address of the BPM Suite 6 Execution Server.

* Point your browser to the JBoss Management Console of your FSW enabled Openshift environment.
* Navigate as follows:  _Profile -> General Configuration -> System Properties -> Add
image::images/add_sys_props.png[]

* Add two additional System Properties as follows:

image::images/sys_props_added.png[]

. bpms.exec.server.hostname :   http://<your_bpms_server_address>
. bpms.exec.server.port :   80

The value of _bpms.exec.server.hostname_ should be replaced with the server address of your BPM Suite 6 enabled Openshift environment.

=== FSW:  Create JMS Queue
This reference architecture includes a SwitchYard application that consumes a message from a queue.
The SwitchYard application uses data from the message to start and manage the lifecycle of remote BPM process instances.
This section describes the procedure to create this business queue in your FSW enabled Openshift gear.

. Open the JBoss EAP Management Conosle to your remote FSW enabled Openshift gear.
. Navigate to:  Profile -> Subsystems -> Messaging -> Destinations -> Default -> View -> Queues/Topics -> Add
. Populate the dialogue box as follows:
.. Name : processMgmtQueue
.. JNDI Names:  java:/queue/processMgmtQueue
. Click the _Save_ button

=== FSW:  Deploy _processLifecycleMgmt_ SwitchYard application
image::images/processMgmt-app.png[]

The purpose of the _processLifecycleMgmt_ application is to demonstrate execution of the lifecycle of a remote process instance from SwitchYard.
_processLifecycleMgmt_ is a SwitchYard application that consumes a message from a queue and executes through the entire life-cycle of a process instance.
It utilizes the two system properties previously defined to invoke the Execution Server of the BPM Suite 6 enabled Openshift environment.
The _processLifecycleMgmt_ SwitchYard application was built previously when this entire reference architecture was built using maven in your local environment.
Execute the following to deploy the _processLifecycleMgmt_ from your local environment to your FSW environment:

.  Point your browser to the JBoss Management Console of your FSW enabled Openshift environment
.  Navigate as follows:  _Runtime -> Manage Deployments -> Add -> Choose File
.  Select the $REF_ARCH_HOME/serviceTier/processLifecycleMgmt/target/processInstanceMgmt-1.1.1-p5-redhat-1.jar  artifact.

image::images/add_deployment.png[]

.  Once deployed, the artifact needs to be enabled.  Select the newly deployed processInstanceMgmt artifact and click the _enable_ button.


=== FSW:  Deploy _policyMgmt_ SwitchYard application
image::images/policyMgmt-app.png[]

The purpose of the _policyMgmt_ application is to expose a RESTful service that any REST client (to include a RESTful Service Task node included in a BPMN2 process definition) can POST to.
To deploy the _policyMgmt_ application, follow the exact procedure used to deploy the _processLifecycleMgmt_ application.
This time, however, select the following artifact to deploy:

* $REF_ARCH_HOME/serviceTier/policyQuote/target/policyQuote-1.1.1-p5-redhat-1.jar


=== Exception Handling
* https://bugzilla.redhat.com/show_bug.cgi?id=1091061


== Execution:
Execution of this reference architecture begins with sending one or more messages to a business queue called _queue/processMgmtQueue_ .
The JMS Client is located in the *$REF_ARCH_HOME/loadTest* directory of this reference architecture.
The name of the class is *com.redhat.gpe.refarch.bpm_jms_exec_server.loadtest.JMSClient*.
Note that this class also extends the JMeter AbstractJavaSamplerClient class.
Use of JMeter with this reference architecture will be discussed in the next section of this documentation.

=== Port-forward Hornetq port
The HornetQ broker embedded in your remote FSW enabled Openshift environment listens by default on port 5445.
This port is not open in an Openshift environment.
Subsquently, port 5445 needs to be tunnelled using ssh from your local to your remote FSW environments.

.Obtain the IP address for the OSE internal NIC
----------
ssh <ssh_url_to_your_fsw_openshift_environment> 'echo $OPENSHIFT_FSW_IP'
----------

.Port Forwarding command for HornetQ access
----------
ssh -N -L localhost:5445:<ipaddress from previous step>:5445 <ssh_url_to_your_fsw_openshift_environment>
----------

While the port forwarding process is running, the HornetQ broker can be accessed on the local computer at `localhost:5445`.
Use `Ctrl+c` to kill port forwarding.

=== Execute JMeter client
By default, the configuration in $REF_ARCH_HOME/loadtest will direct JMeter to send one JMS message (from only one thread) to the JMS broker at localhost:5445.
Execute a smoke test of your deployed reference architecture via the following:

.  cd $REF_ARCH_HOME/loadtest
.  mvn clean verify

== To-Do
* specify role used to query for potential tasks
* demonstrate invocation of the following BPM Suite 6 task operation:  claimnextavailable
* error handling when substitution properties in URL of REST invocation are not valid
** currently rolls back outside of scope of ProcessMgmtBean
** causes multiple invocations of startProcess call)
